<views:MvxPhonePage
    x:Class="JabbR.Client.WP8.UI.Views.RoomView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:phone="clr-namespace:Microsoft.Phone.Controls;assembly=Microsoft.Phone"
    xmlns:shell="clr-namespace:Microsoft.Phone.Shell;assembly=Microsoft.Phone"
    xmlns:interactivity="clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity"
    xmlns:commandbinding="clr-namespace:Cirrious.MvvmCross.WindowsPhone.Commands;assembly=Cirrious.MvvmCross.WindowsPhone"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:views="clr-namespace:Cirrious.MvvmCross.WindowsPhone.Views;assembly=Cirrious.MvvmCross.WindowsPhone"
    xmlns:controls="clr-namespace:JabbR.Client.WP8.UI.Controls"
    xmlns:converters="clr-namespace:JabbR.Client.WP8.UI.Converters"
    mc:Ignorable="d"
    FontFamily="{StaticResource PhoneFontFamilyNormal}"
    FontSize="{StaticResource PhoneFontSizeNormal}"
    Foreground="{StaticResource PhoneForegroundBrush}"
    SupportedOrientations="Portrait"  Orientation="Portrait"
    shell:SystemTray.IsVisible="True">

    <views:MvxPhonePage.Resources>
        <converters:HastToGravatarConverter x:Key="HashToGravatarConverter"/>
        <converters:HtmlToStringConverter x:Key="HtmlToStringConverter"/>
        <converters:NativeVisibilityConverter x:Key="NativeVisibilityConverter"/>
    </views:MvxPhonePage.Resources>
    <Grid x:Name="LayoutRoot" Background="Transparent">
        <phone:Pivot Title="{Binding Room.Name}" 
                     SelectionChanged="Pivot_SelectionChanged"
                     VerticalAlignment="Stretch" 
                     HorizontalAlignment="Stretch">
            <phone:PivotItem Header="messages">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <ListBox x:Name="RecentMessage"
                             Height="465"
                             Margin="0,-5,0,-50"
                             VerticalAlignment="Top"
                             ItemsSource="{Binding Messages}">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalAlignment" Value="Stretch"/>
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <ListBoxItem HorizontalContentAlignment="Stretch" Padding="12">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="50"/>
                                            <RowDefinition Height="*"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="50"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Image Grid.RowSpan="2" Height="50" Width="50" Margin="0,0,6,0" Source="{Binding User.Hash, Converter={StaticResource HashToGravatarConverter}}"/>
                                        <TextBlock Grid.Column="1" Margin="6,0,0,0" VerticalAlignment="Bottom" Text="{Binding User.Name}" Style="{StaticResource PhoneTextLargeStyle}">
                                            <TextBlock.Foreground>
                                                <SolidColorBrush Color="{StaticResource PhoneAccentColor}"/>
                                            </TextBlock.Foreground>
                                        </TextBlock>
                                        <TextBlock Grid.Row="1" Grid.Column="1" Margin="6,0,0,0" TextWrapping="Wrap" Text="{Binding Content, Converter={StaticResource HtmlToStringConverter}, Mode=OneWay}" Style="{StaticResource PhoneTextNormalStyle}"/>
                                        <TextBlock Grid.Row="2" Grid.Column="1" HorizontalAlignment="Right" Text="{Binding When.LocalDateTime}" Style="{StaticResource PhoneTextSmallStyle}" FontSize="13.333"></TextBlock>
                                    </Grid>
                                </ListBoxItem>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    <TextBox x:Name="Message"
                             Grid.Row="1"
                             Margin="0,6,0,0"
                             Text="{Binding Message, Mode=TwoWay, UpdateSourceTrigger=Explicit}" 
                             TextChanged="Message_TextChanged"
                             InputScope="Text" FontFamily="Segoe UI Symbol" HorizontalContentAlignment="Stretch" BorderThickness="0" TextWrapping="Wrap"/>
                </Grid>
            </phone:PivotItem>

            <phone:PivotItem Header="users">
                <ListBox x:Name="Users" ItemsSource="{Binding Users}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid VerticalAlignment="Center" Margin="12,6">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Image Height="32" Width="32" Margin="0,0,6,0" Source="{Binding Hash, Converter={StaticResource HashToGravatarConverter}}"/>
                                <TextBlock Grid.Column="1" Margin="6,0,0,0" VerticalAlignment="Bottom" Text="{Binding Name}" Style="{StaticResource PhoneTextLargeStyle}">
                                    <TextBlock.Foreground>
                                        <SolidColorBrush Color="{StaticResource PhoneAccentColor}"/>
                                    </TextBlock.Foreground>
                                </TextBlock>
                                <StackPanel Orientation="Vertical" VerticalAlignment="Top" Grid.Column="1" Grid.Row="1">
                                    <StackPanel Orientation="Horizontal" Visibility="{Binding Note, Converter={StaticResource NativeVisibilityConverter}}">
                                        <Canvas xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" x:Name="appbar_paperclip" Width="38" Height="38" Clip="F1 M 0,0L 76,0L 76,76L 0,76L 0,0" VerticalAlignment="Top">
                                            <Path Width="11.083" Height="22.167" Canvas.Left="26.9167" Canvas.Top="15.8333" Stretch="Fill" Fill="{StaticResource PhoneForegroundBrush}" Data="F1 M 42.75,24.5417L 42.7499,44.3334C 42.7499,46.9567 40.6233,49.0834 37.9999,49.0834C 35.3766,49.0834 33.25,46.9567 33.25,44.3334L 33.25,28.5L 36.4166,28.5L 36.4166,44.3334C 36.4166,45.2078 37.1255,45.9167 37.9999,45.9167C 38.8744,45.9167 38.7916,45.2078 38.7916,44.3334L 38.7917,24.5417C 38.7917,22.3556 37.8111,20.5833 35.625,20.5833C 33.4389,20.5833 31.6667,22.3555 31.6667,24.5417L 31.6667,49.0833C 31.6667,52.5811 34.5022,55.4167 38,55.4167C 41.4978,55.4167 44.3333,52.5811 44.3333,49.0833L 44.3333,30.0833L 49.0833,30.0833L 49.0833,49.0833C 49.0833,55.2045 44.1211,60.1667 38,60.1667C 31.8788,60.1667 26.9167,55.2045 26.9167,49.0833L 26.9167,23.75C 26.9167,19.3778 30.4611,15.8333 34.8333,15.8333C 39.2056,15.8333 42.75,19.3778 42.75,23.75L 42.7109,24.5417L 42.75,24.5417 Z "/>
                                        </Canvas>
                                        <TextBlock Margin="6,0,0,0" Width="350" TextWrapping="Wrap" Text="{Binding Note}" Foreground="{StaticResource PhoneForegroundBrush}" VerticalAlignment="Bottom"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Visibility="{Binding IsAfk, Converter={StaticResource NativeVisibilityConverter}}">
                                        <Canvas xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" x:Name="appbar_timer" Width="38" Height="38" Clip="F1 M 0,0L 76,0L 76,76L 0,76L 0,0" VerticalAlignment="Top">
                                            <Path Width="17.417" Height="19" Canvas.Left="22.1667" Canvas.Top="19" Stretch="Fill" Fill="{StaticResource PhoneForegroundBrush}" Data="F1 M 53.8333,41.1667C 53.8333,49.9112 46.7445,57 38,57C 29.2555,57 22.1667,49.9112 22.1667,41.1667C 22.1667,32.9565 28.4156,26.2059 36.4167,25.4115L 36.4167,23.75L 31.6667,23.75L 31.6667,19L 44.3333,19L 44.3333,23.75L 39.5833,23.75L 39.5833,25.4115C 42.7678,25.7277 45.6747,26.9874 48.0205,28.907L 49.1629,27.7646L 46.9237,25.5254L 50.2825,22.1667L 57,28.8842L 53.6412,32.2429L 51.4021,30.0038L 50.2597,31.1462C 52.4933,33.8756 53.8333,37.3647 53.8333,41.1667 Z M 26.2296,39.5834L 30.0833,39.5834L 30.0833,42.75L 26.2296,42.75C 26.9347,48.0419 31.1248,52.232 36.4166,52.9371L 36.4166,49.0833L 39.5833,49.0833L 39.5833,52.937C 44.8752,52.232 49.0653,48.0419 49.7703,42.75L 45.9166,42.75L 45.9166,39.5834L 49.7703,39.5834C 49.0652,34.2915 44.8751,30.1014 39.5833,29.3964L 39.5833,33.25L 36.4166,33.25L 36.4166,29.3963C 31.1248,30.1014 26.9347,34.2915 26.2296,39.5834 Z M 38,38C 39.7489,38 41.1666,39.4178 41.1666,41.1667C 41.1666,42.9156 39.7489,44.3334 38,44.3334L 31.6666,49.0834L 34.8333,41.1667C 34.8333,39.4178 36.2511,38 38,38 Z "/>
                                        </Canvas>
                                        <TextBlock Margin="6,0,0,0" Width="350" TextWrapping="Wrap" Text="{Binding AfkNote}" Foreground="{StaticResource PhoneForegroundBrush}" VerticalAlignment="Bottom"/>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </phone:PivotItem>
        </phone:Pivot>
        <controls:BindableApplicationBar Grid.Row="2" x:Name="AppBar">
            <controls:BindableApplicationBarIconButton IconUri="/Assets/AppBar/appbar.send.text.rest.png" Text="Send" controls:AppBarItemClick.Command="{Binding SendMessageCommand}" />
        </controls:BindableApplicationBar>
    </Grid>
</views:MvxPhonePage>